<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>é…’åº—é‡‡è´­å®¡æ‰¹ç³»ç»Ÿ v4.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Microsoft YaHei",sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}

/* ç™»å½•é¡µé¢ */
.login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-box{background:#fff;border-radius:20px;padding:40px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.login-title{text-align:center;margin-bottom:30px}
.login-title h1{font-size:28px;color:#667eea;margin-bottom:10px}
.login-title p{color:#666;font-size:14px}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-weight:600;margin-bottom:8px;color:#333}
.form-group input{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;transition:border-color .3s}
.form-group input:focus{outline:none;border-color:#667eea}
.btn{padding:12px 24px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;width:100%}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,.4)}
.login-error{background:#fee;color:#c00;padding:10px;border-radius:8px;margin-bottom:15px;display:none;font-size:14px}
.login-accounts{margin-top:25px;padding-top:20px;border-top:1px solid #eee}
.login-accounts p{font-size:12px;color:#999;margin-bottom:10px}
.login-accounts table{width:100%;font-size:12px;color:#666}
.login-accounts td{padding:3px 5px}

/* ä¸»åº”ç”¨ */
.app-container{display:none;min-height:100vh}
.header{background:#fff;padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
.header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.header-left h1{font-size:20px;color:#667eea}
.header-left span{font-size:12px;color:#999}
.header-right{display:flex;align-items:center;gap:15px}
.user-info{font-size:14px;color:#333}
.user-info strong{color:#667eea}
.btn-logout{padding:8px 16px;background:#ff6b6b;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px}
.btn-logout:hover{background:#ee5a5a}

.main-content{max-width:1200px;margin:20px auto;padding:0 20px}

/* å¯¼èˆªæ ‡ç­¾ */
.nav-tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.nav-tab{padding:12px 24px;background:#fff;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;color:#666}
.nav-tab:hover{border-color:#667eea;color:#667eea}
.nav-tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
.nav-tab.hidden{display:none}

/* é¢æ¿ */
.panel{display:none;background:#fff;border-radius:16px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.1)}
.panel.active{display:block}
.panel-header{font-size:18px;font-weight:600;color:#333;margin-bottom:20px;padding-bottom:15px;border-bottom:3px solid #667eea}

/* è¡¨å• */
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
.form-group.full{grid-column:1/-1}
textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;font-family:inherit;resize:vertical}
textarea:focus{outline:none;border-color:#667eea}
select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;background:#fff}
select:focus{outline:none;border-color:#667eea}

/* é‡‡è´­æ¸…å• */
.items-section{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px}
.upload-area{border:2px dashed #ccc;border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all .3s;color:#666}
.upload-area:hover{border-color:#667eea;color:#667eea;background:#f8f9ff}
.file-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#f0f0f0;border-radius:6px;margin-top:5px}
.file-item button{background:#ff6b6b;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer}
.items-section h3{margin-bottom:15px;color:#333}
.item-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px;margin-bottom:10px;align-items:end}
.item-row input{padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px}
.item-row input:focus{outline:none;border-color:#667eea}
.btn-remove{padding:10px 15px;background:#ff6b6b;color:#fff;border:none;border-radius:8px;cursor:pointer}
.btn-add{padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:10px}
.items-total{margin-top:15px;padding:15px;background:#e3f2fd;border-radius:8px;font-size:16px;font-weight:600}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:12px;text-align:center}
.stat-card.green{background:linear-gradient(135deg,#28a745,#20c997)}
.stat-card.red{background:linear-gradient(135deg,#dc3545,#fd7e14)}
.stat-card.blue{background:linear-gradient(135deg,#17a2b8,#20c997)}
.stat-card.orange{background:linear-gradient(135deg,#ffc107,#ff9800);color:#333}
.stat-number{font-size:32px;font-weight:700}
.stat-label{font-size:13px;margin-top:5px;opacity:.9}

/* ç”³è¯·å¡ç‰‡ */
.app-card{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:20px;margin-bottom:15px}
.app-card.pending{border-left:5px solid #ffc107}
.app-card.approved{border-left:5px solid #28a745}
.app-card.rejected{border-left:5px solid #dc3545}
.app-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
.app-no{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}
.status-badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}
.status-pending{background:#fff3cd;color:#856404}
.status-approved{background:#d4edda;color:#155724}
.status-rejected{background:#f8d7da;color:#721c24}
.app-card-body{margin-bottom:15px}
.app-card-body p{margin-bottom:8px;color:#555;font-size:14px}
.app-items{background:#f8f9fa;padding:12px;border-radius:8px;margin-top:10px}
.app-items table{width:100%;font-size:13px}
.app-items th,.app-items td{padding:8px;text-align:left;border-bottom:1px solid #e0e0e0}
.app-items th{font-weight:600;color:#333}
.app-card-actions{display:flex;gap:10px;flex-wrap:wrap}
.btn-small{padding:8px 16px;font-size:13px;border:none;border-radius:6px;cursor:pointer;font-weight:600}
.btn-success{background:#28a745;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
.btn-warning{background:#ffc107;color:#333}
.btn-info{background:#17a2b8;color:#fff}
.btn-secondary{background:#6c757d;color:#fff}

/* AIå»ºè®® */
.ai-suggestion{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;border-radius:8px;margin-bottom:15px;font-size:14px;white-space:pre-line}
.ai-consumption{background:#fff3e0;border-left:4px solid #ff9800;padding:15px;border-radius:8px;margin-bottom:15px;font-size:14px;white-space:pre-line}

/* å®¡æ‰¹è¡¨å• */
.review-form{margin-top:15px;padding-top:15px;border-top:2px dashed #e0e0e0}
.review-form textarea{margin-bottom:10px}

/* ç©ºçŠ¶æ€ */
.empty-state{text-align:center;padding:60px 20px;color:#999}
.empty-state .icon{font-size:64px;margin-bottom:20px}

/* åŠ è½½çŠ¶æ€ */
.loading{text-align:center;padding:40px;color:#666}
.loading::after{content:'';display:inline-block;width:20px;height:20px;border:3px solid #667eea;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* æç¤ºæ¶ˆæ¯ */
.toast{position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:10px;color:#fff;font-weight:600;z-index:9999;animation:slideIn .3s ease}
.toast.success{background:#28a745}
.toast.error{background:#dc3545}
.toast.info{background:#17a2b8}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* æ¨¡æ€æ¡† */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;padding:20px;overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:16px;padding:25px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #667eea}
.modal-header h3{font-size:18px;color:#333}
.modal-close{font-size:28px;color:#999;cursor:pointer;line-height:1}
.modal-close:hover{color:#333}

/* å“åº”å¼ */
@media(max-width:768px){
  .item-row{grid-template-columns:1fr}
  .header-content{flex-direction:column;text-align:center}
  .nav-tabs{justify-content:center}
}
/* å¸¸ç”¨ç‰©å“é€‰æ‹©å™¨ */
.common-items-selector{background:#f0f7ff;border:2px solid #667eea;border-radius:12px;padding:15px;margin-bottom:20px}
.common-items-selector h4{color:#667eea;margin-bottom:15px;font-size:16px}
.category-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px}
.category-tab{padding:8px 16px;background:#fff;border:2px solid #e0e0e0;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s}
.category-tab:hover{border-color:#667eea;color:#667eea}
.category-tab.active{background:#667eea;color:#fff;border-color:#667eea}
.category-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;max-height:200px;overflow-y:auto}
.common-item{padding:10px;background:#fff;border:2px solid #e0e0e0;border-radius:8px;cursor:pointer;transition:all .3s;text-align:center}
.common-item:hover{border-color:#667eea;background:#f8f9ff}
.common-item .item-name{font-weight:600;color:#333;margin-bottom:5px}
.common-item .item-info{font-size:12px;color:#666}
.manage-items-btn{margin-top:10px;padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px}
.manage-items-btn:hover{background:#218838}
</style>
</head>
<body>

<!-- ========== ç™»å½•é¡µé¢ ========== -->
<div class="login-container" id="loginPage">
  <div class="login-box">
    <div class="login-title">
      <h1>ğŸ¨ é…’åº—é‡‡è´­å®¡æ‰¹ç³»ç»Ÿ</h1>
      <p>v4.0 æœåŠ¡å™¨ç‰ˆ - è¯·ç™»å½•</p>
    </div>
    <p style="text-align:center;color:#555;font-size:16px;margin-bottom:20px">æ¬¢è¿ä½¿ç”¨é…’åº—é‡‡è´­ç®¡ç†ç³»ç»Ÿ</p>
    <div class="login-error" id="loginError"></div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
      </div>
      <button type="submit" class="btn btn-primary">ğŸ” ç™»å½•</button>
    </form>  
  </div>
</div>

<!-- ========== ä¸»åº”ç”¨ ========== -->
<div class="app-container" id="appContainer">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <h1>ğŸ¨ é…’åº—é‡‡è´­å®¡æ‰¹ç³»ç»Ÿ</h1>
        <span>v4.0 æœåŠ¡å™¨ç‰ˆ</span>
      </div>
      <div class="header-right">
        <div class="user-info">
          æ¬¢è¿ï¼Œ<strong id="currentUserName">-</strong>
          (<span id="currentUserRole">-</span>)
        </div>
        <button class="btn-logout" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </header>

  <div class="main-content">
    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <div class="nav-tabs">
      <div class="nav-tab active" data-panel="submit" data-roles="purchaser,admin">ğŸ“ æäº¤ç”³è¯·</div>
      <div class="nav-tab" data-panel="myApps" data-roles="purchaser,admin">ğŸ“‹ æˆ‘çš„ç”³è¯·</div>
      <div class="nav-tab" data-panel="approve" data-roles="boss,admin">ğŸ‘” å®¡æ‰¹ç®¡ç†</div>
      <div class="nav-tab" data-panel="finance" data-roles="finance,admin">ğŸ’° è´¢åŠ¡æŠ¥è´¦</div>
      <div class="nav-tab" data-panel="users" data-roles="boss,admin">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
      <div class="nav-tab" data-panel="aiData" data-roles="boss,admin">ğŸ¤– AIæ•°æ®ç®¡ç†</div>
    </div>

    <!-- ====== æäº¤ç”³è¯·é¢æ¿ ====== -->
    <div class="panel active" id="panelSubmit">
      <div class="panel-header">ğŸ“ æäº¤é‡‡è´­ç”³è¯·</div>
      <form onsubmit="submitApplication(event)">
        <div class="form-row">
          <div class="form-group">
            <label>é‡‡è´­æ—¥æœŸ</label>
            <input type="date" id="submitDate" required>
          </div>
        </div>
        <div class="form-group">
          <label>å¤‡æ³¨è¯´æ˜</label>
          <textarea id="submitNotes" rows="2" placeholder="ä¾‹å¦‚ï¼šèŠ‚å‡æ—¥å¤‡è´§"></textarea>
        </div>
        <div class="form-group">
  <label>ğŸ“ ä¸Šä¼ é™„ä»¶ï¼ˆå›¾ç‰‡/æ–‡ä»¶ï¼‰</label>
  <input type="file" id="submitFiles" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" style="display:none">
  <div class="upload-area" onclick="document.getElementById('submitFiles').click()">
    <div style="font-size:40px;margin-bottom:10px">ğŸ“</div>
    <div>ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶ï¼ˆæœ€å¤š5ä¸ªï¼‰</div>
  </div>
  <div id="fileList" style="margin-top:10px"></div>
</div>
<!-- å¸¸ç”¨ç‰©å“é€‰æ‹©å™¨ -->
        <div class="common-items-selector" id="commonItemsSelector">
          <h4>ğŸ“¦ å¸¸ç”¨ç‰©å“å¿«é€Ÿé€‰æ‹©</h4>
          <div class="category-tabs" id="categoryTabs"></div>
          <div class="category-items" id="categoryItems"></div>
          <button type="button" class="manage-items-btn" onclick="openManageItemsModal()">âš™ï¸ ç®¡ç†å¸¸ç”¨ç‰©å“</button>
        </div>
        <div class="items-section">
          <h3>ğŸ“¦ é‡‡è´­æ¸…å•</h3>
          <div id="submitItems">
            <div class="item-row">
              <input type="text" placeholder="ç‰©å“åç§°" class="item-name" required>
              <input type="number" placeholder="æ•°é‡" class="item-qty" step="0.01" required>
              <input type="text" placeholder="å•ä½" class="item-unit" required>
              <input type="number" placeholder="å•ä»·" class="item-price" step="0.01" required>
              <button type="button" class="btn-remove" onclick="removeItem(this)">åˆ é™¤</button>
            </div>
          </div>
          <button type="button" class="btn-add" onclick="addItem()">â• æ·»åŠ ç‰©å“</button>
          <div class="items-total">æ€»é‡‘é¢ï¼šÂ¥<span id="submitTotal">0.00</span></div>
        </div>
        
        <button type="submit" class="btn btn-primary" style="margin-top:20px">ğŸš€ æäº¤ç”³è¯·</button>
      </form>
    </div>

    <!-- ====== æˆ‘çš„ç”³è¯·é¢æ¿ ====== -->
    <div class="panel" id="panelMyApps">
    <div class="panel-header">ğŸ“‹ æˆ‘çš„ç”³è¯·</div>
    <div class="form-row" style="margin-bottom:20px">
        <div class="form-group">
        <label>ğŸ” æœç´¢ç‰©å“:</label>
        <input type="text" id="myAppsSearchItem" placeholder="è¾“å…¥ç‰©å“åç§°" onkeyup="if(event.key==='Enter')loadMyApps()">
    </div>
    <div class="form-group">   
          <label>ç­›é€‰çŠ¶æ€:</label>
            <select id="myAppsFilterStatus" onchange="loadMyApps()">
                <option value="">å…¨éƒ¨</option>
                <option value="pending">å¾…å®¡æ‰¹</option>
                <option value="approved">å·²é€šè¿‡</option>
                <option value="rejected">å·²é©³å›</option>
                <option value="accounted">å·²æŠ¥è´¦</option>
            </select>
        </div>
    </div>
    <div id="myAppsList"></div>
</div>

    <!-- ====== å®¡æ‰¹ç®¡ç†é¢æ¿ ====== -->
    <div class="panel" id="panelApprove">
      <div class="panel-header">ğŸ‘” å®¡æ‰¹ç®¡ç†</div>
      <div class="stats-grid" id="approveStats"></div>
      <div class="form-row" style="margin-bottom:20px">
        <div class="form-group">
          <label>ğŸ” æœç´¢ç‰©å“</label>
          <input type="text" id="approveSearchItem" placeholder="è¾“å…¥ç‰©å“åç§°" onkeyup="if(event.key==='Enter')loadApproveList()">
        </div>
        <div class="form-group">
          <label>ç­›é€‰çŠ¶æ€</label>
          <select id="filterStatus" onchange="loadApproveList()">
            <option value="">å…¨éƒ¨</option>
            <option value="pending">å¾…å®¡æ‰¹</option>
            <option value="approved">å·²é€šè¿‡</option>
            <option value="rejected">å·²é©³å›</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:15px">
        <button class="btn-small btn-success" onclick="exportExcel('approve')">ğŸ“¥ å¯¼å‡ºExcel</button>
      </div>
      <div id="approveList"></div>
    </div>

    <!-- ====== è´¢åŠ¡æŠ¥è´¦é¢æ¿ ====== -->
    <div class="panel" id="panelFinance">
      <div class="panel-header">ğŸ’° è´¢åŠ¡æŠ¥è´¦</div>
      <div class="stats-grid" id="financeStats"></div>
      <div class="form-row" style="margin-bottom:20px">
        <div class="form-group">
          <label>ğŸ” æœç´¢ç‰©å“</label>
          <input type="text" id="financeSearchItem" placeholder="è¾“å…¥ç‰©å“åç§°" onkeyup="if(event.key==='Enter')loadFinanceList()">
        </div>
      </div>
      <div style="margin-bottom:20px">
        <button class="btn-small btn-success" onclick="openCountModal()">ğŸ‘¥ ç™»è®°äººæ•°</button>
      <button class="btn-small btn-info" onclick="viewCountHistory()">ğŸ“Š äººæ•°è®°å½•</button>
        <button class="btn-small btn-warning" onclick="exportExcel('finance')">ğŸ“¥ å¯¼å‡ºExcel</button>
      </div>
      <div id="financeList"></div>
    </div>

   <!-- ====== ç”¨æˆ·ç®¡ç†é¢æ¿ ====== -->
    <div class="panel" id="panelUsers">
      <div class="panel-header">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
      <button class="btn-small btn-primary" onclick="openAddUserModal()" style="margin-bottom:20px">â• æ·»åŠ ç”¨æˆ·</button>
      <div id="usersList"></div>
    </div>

    <!-- ====== AIæ•°æ®ç®¡ç†é¢æ¿ ====== -->
<div class="panel" id="panelAiData">
  <div class="panel-header">ğŸ¤– AIæ•°æ®ç®¡ç†</div>
  
  <div style="margin-bottom:20px">
    <button class="btn-small btn-primary" onclick="loadAIPrices()">ğŸ’° ä»·æ ¼æ•°æ®</button>
    <button class="btn-small btn-info" onclick="loadAIConsumption()">ğŸ“Š æ¶ˆè€—æ•°æ®</button>
    <button class="btn-small btn-success" onclick="exportAIData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
    <button class="btn-small btn-warning" onclick="openAddPriceModal()">â• æ·»åŠ ä»·æ ¼</button>
  </div>
  
  <div class="form-row" style="margin-bottom:15px">
    <div class="form-group">
      <label>ğŸ” æœç´¢ç‰©å“</label>
      <input type="text" id="aiSearchKeyword" placeholder="è¾“å…¥ç‰©å“åç§°å…³é”®å­—" oninput="filterAIData()">
    </div>
  </div>
  
  <div id="aiDataList"></div>
</div>
  </div>
</div>

<!-- ========== æ¨¡æ€æ¡† ========== -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">æ ‡é¢˜</h3>
      <span class="modal-close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- ========== JavaScript ========== -->
<script>
// ============================================================
// å…¨å±€å˜é‡
// ============================================================
const API_BASE = '/api';  // APIåŸºç¡€è·¯å¾„
let currentUser = null;   // å½“å‰ç™»å½•ç”¨æˆ·
let authToken = null;     // è®¤è¯ä»¤ç‰Œ
// æ–‡ä»¶ä¸Šä¼ ç›¸å…³
let selectedFiles = [];

// å¤„ç†æ–‡ä»¶é€‰æ‹©
document.getElementById('submitFiles').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  
  if (selectedFiles.length + files.length > 5) {
    showToast('æœ€å¤šåªèƒ½ä¸Šä¼ 5ä¸ªæ–‡ä»¶', 'error');
    return;
  }
  
  files.forEach(file => {
    if (file.size > 10 * 1024 * 1024) {
      showToast(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶`, 'error');
      return;
    }
    selectedFiles.push(file);
  });
  
  updateFileList();
  e.target.value = ''; // æ¸…ç©ºinputä»¥ä¾¿é‡å¤é€‰æ‹©
});

// æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
function updateFileList() {
  const container = document.getElementById('fileList');
  if (selectedFiles.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = '';
  selectedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'file-item';
    
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        div.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px">
            <img src="${e.target.result}" style="width:50px;height:50px;object-fit:cover;border-radius:4px">
            <span>${file.name} (${(file.size/1024).toFixed(1)}KB)</span>
          </div>
          <button type="button" onclick="removeFile(${index})">åˆ é™¤</button>
        `;
      };
      reader.readAsDataURL(file);
    } else {
      div.innerHTML = `
        <span>ğŸ“„ ${file.name} (${(file.size/1024).toFixed(1)}KB)</span>
        <button type="button" onclick="removeFile(${index})">åˆ é™¤</button>
      `;
    }
    
    container.appendChild(div);
  });
}

// åˆ é™¤æ–‡ä»¶
function removeFile(index) {
  selectedFiles.splice(index, 1);
  updateFileList();
}
// ============================================================
// å·¥å…·å‡½æ•°
// ============================================================

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// APIè¯·æ±‚å°è£…
async function apiRequest(endpoint, options = {}) {
  const url = API_BASE + endpoint;
  const headers = {
    'Content-Type': 'application/json',
    ...options.headers
  };
  
  // æ·»åŠ è®¤è¯ä»¤ç‰Œ
  if (authToken) {
    headers['Authorization'] = `Bearer ${authToken}`;
  }
  
  try {
    const response = await fetch(url, {
      ...options,
      headers
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
    }
    
    return data;
  } catch (error) {
    console.error('APIè¯·æ±‚é”™è¯¯:', error);
    throw error;
  }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// ============================================================
// ç™»å½•/ç™»å‡º
// ============================================================

// å¤„ç†ç™»å½•
async function handleLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const errorDiv = document.getElementById('loginError');
  
  try {
    errorDiv.style.display = 'none';
    
    const result = await apiRequest('/auth/login', {
      method: 'POST',
      body: JSON.stringify({ username, password })
    });
    
    // ä¿å­˜ç™»å½•ä¿¡æ¯
    authToken = result.data.token;
    currentUser = result.data.user;
    
    // å­˜å‚¨åˆ°localStorageï¼ˆåˆ·æ–°é¡µé¢åä»ä¿æŒç™»å½•ï¼‰
    localStorage.setItem('authToken', authToken);
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // æ˜¾ç¤ºä¸»åº”ç”¨
    showApp();
    showToast('ç™»å½•æˆåŠŸï¼', 'success');
    
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.style.display = 'block';
  }
}

// å¤„ç†ç™»å‡º
function handleLogout() {
  authToken = null;
  currentUser = null;
  localStorage.removeItem('authToken');
  localStorage.removeItem('currentUser');
  
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appContainer').style.display = 'none';
  
  // æ¸…ç©ºè¡¨å•
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  
  showToast('å·²é€€å‡ºç™»å½•', 'info');
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€
function checkAuth() {
  const savedToken = localStorage.getItem('authToken');
  const savedUser = localStorage.getItem('currentUser');
  
  if (savedToken && savedUser) {
    authToken = savedToken;
    currentUser = JSON.parse(savedUser);
    showApp();
  }
}

// æ˜¾ç¤ºä¸»åº”ç”¨
function showApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appContainer').style.display = 'block';
  
  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
  document.getElementById('currentUserName').textContent = currentUser.name;
  const roleNames = {
    purchaser: 'é‡‡è´­å‘˜',
    boss: 'è€æ¿',
    finance: 'è´¢åŠ¡',
    admin: 'ç®¡ç†å‘˜'
  };
  document.getElementById('currentUserRole').textContent = roleNames[currentUser.role] || currentUser.role;
  
  // æ ¹æ®è§’è‰²æ˜¾ç¤º/éšè—å¯¼èˆªæ ‡ç­¾
  document.querySelectorAll('.nav-tab').forEach(tab => {
    const roles = tab.dataset.roles.split(',');
    if (roles.includes(currentUser.role)) {
      tab.classList.remove('hidden');
    } else {
      tab.classList.add('hidden');
    }
  });
  
  // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§çš„æ ‡ç­¾å¹¶æ¿€æ´»
  const firstVisibleTab = document.querySelector('.nav-tab:not(.hidden)');
  if (firstVisibleTab) {
    switchPanel(firstVisibleTab.dataset.panel);
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    firstVisibleTab.classList.add('active');
  }
  
  // åˆå§‹åŒ–æ—¥æœŸ
  document.getElementById('submitDate').value = new Date().toISOString().split('T')[0];
  // åŠ è½½å¸¸ç”¨ç‰©å“
  loadCommonItems();
}

// ============================================================
// é¢æ¿åˆ‡æ¢
// ============================================================

// åˆ‡æ¢é¢æ¿
function switchPanel(panelName) {
  // éšè—æ‰€æœ‰é¢æ¿
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  
  // æ˜¾ç¤ºç›®æ ‡é¢æ¿
  const panel = document.getElementById('panel' + panelName.charAt(0).toUpperCase() + panelName.slice(1));
  if (panel) {
    panel.classList.add('active');
    
    // åŠ è½½é¢æ¿æ•°æ®
    if (panelName === 'myApps') loadMyApps();
    if (panelName === 'approve') loadApproveList();
    if (panelName === 'finance') loadFinanceList();
    if (panelName === 'users') loadUsers();
    if (panelName === 'aiData') loadAIPrices();
  }
}

// å¯¼èˆªæ ‡ç­¾ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    if (this.classList.contains('hidden')) return;
    
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    switchPanel(this.dataset.panel);
  });
});

// ============================================================
// æäº¤ç”³è¯·
// ============================================================

// æ·»åŠ ç‰©å“è¡Œ
function addItem() {
  const container = document.getElementById('submitItems');
  const row = document.createElement('div');
  row.className = 'item-row';
  row.innerHTML = `
    <input type="text" placeholder="ç‰©å“åç§°" class="item-name" required>
    <input type="number" placeholder="æ•°é‡" class="item-qty" step="0.01" required>
    <input type="text" placeholder="å•ä½" class="item-unit" required>
    <input type="number" placeholder="å•ä»·" class="item-price" step="0.01" required>
    <button type="button" class="btn-remove" onclick="removeItem(this)">åˆ é™¤</button>
  `;
  container.appendChild(row);
}

// åˆ é™¤ç‰©å“è¡Œ
function removeItem(btn) {
  const rows = document.querySelectorAll('#submitItems .item-row');
  if (rows.length > 1) {
    btn.closest('.item-row').remove();
    updateTotal();
  } else {
    showToast('è‡³å°‘ä¿ç•™ä¸€ä¸ªç‰©å“', 'error');
  }
}

// æ›´æ–°æ€»é‡‘é¢
function updateTotal() {
  let total = 0;
  document.querySelectorAll('#submitItems .item-row').forEach(row => {
    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    total += qty * price;
  });
  document.getElementById('submitTotal').textContent = total.toFixed(2);
}

// ç›‘å¬è¾“å…¥å˜åŒ–
document.getElementById('submitItems').addEventListener('input', updateTotal);

// æäº¤ç”³è¯·
async function submitApplication(event) {
  event.preventDefault();
  
  const purchaseDate = document.getElementById('submitDate').value;
  const notes = document.getElementById('submitNotes').value;
  
  // æ”¶é›†ç‰©å“
  const items = [];
  document.querySelectorAll('#submitItems .item-row').forEach(row => {
    const name = row.querySelector('.item-name').value.trim();
    const quantity = parseFloat(row.querySelector('.item-qty').value);
    const unit = row.querySelector('.item-unit').value.trim();
    const price = parseFloat(row.querySelector('.item-price').value);
    
    if (name && quantity > 0 && unit && price > 0) {
      items.push({ name, quantity, unit, price });
    }
  });
  
  if (items.length === 0) {
    showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç‰©å“', 'error');
    return;
  }
  
  try {
    // ä½¿ç”¨ FormData ä¸Šä¼ ï¼ˆæ”¯æŒæ–‡ä»¶ï¼‰
    const formData = new FormData();
    formData.append('purchaseDate', purchaseDate);
    formData.append('notes', notes);
    formData.append('items', JSON.stringify(items));
    
    // æ·»åŠ æ–‡ä»¶
    selectedFiles.forEach(file => {
      formData.append('files', file);
    });
    
    const response = await fetch('/api/applications', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.message || 'æäº¤å¤±è´¥');
    }
    
    showToast(`ç”³è¯·æäº¤æˆåŠŸï¼ç¼–å·ï¼š${result.data.appNo}`, 'success');
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('submitNotes').value = '';
    document.getElementById('submitItems').innerHTML = `
      <div class="item-row">
        <input type="text" placeholder="ç‰©å“åç§°" class="item-name" required>
        <input type="number" placeholder="æ•°é‡" class="item-qty" step="0.01" required>
        <input type="text" placeholder="å•ä½" class="item-unit" required>
        <input type="number" placeholder="å•ä»·" class="item-price" step="0.01" required>
        <button type="button" class="btn-remove" onclick="removeItem(this)">åˆ é™¤</button>
      </div>
    `;
    updateTotal();
    
    // æ¸…ç©ºæ–‡ä»¶
    selectedFiles = [];
    updateFileList();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// ============================================================
// æˆ‘çš„ç”³è¯·
// ============================================================

async function loadMyApps() {
    const container = document.getElementById('myAppsList');
    const filterStatus = document.getElementById('myAppsFilterStatus')?.value || '';
    const searchItem = document.getElementById('myAppsSearchItem')?.value.trim() || '';
    
    try {
        let url = '/applications';
        const params = [];
        
        if (filterStatus === 'accounted') {
            params.push('status=approved');
            params.push('accounting_status=accounted');
        } else if (filterStatus) {
            params.push(`status=${filterStatus}`);
        }
        
        if (searchItem) {
            params.push(`itemName=${encodeURIComponent(searchItem)}`);
        }
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }

        const result = await apiRequest(url);
        let apps = result.data.list;
        
        // å¦‚æœç­›é€‰å·²æŠ¥è´¦ï¼Œéœ€è¦é¢å¤–è¿‡æ»¤
        if (filterStatus === 'accounted') {
            apps = apps.filter(app => app.accounting_status === 'accounted');
        }
        
        if (apps.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>æš‚æ— ç”³è¯·è®°å½•</p></div>';
            return;
        }
        
        container.innerHTML = apps.map(app => renderAppCard(app, 'view')).join('');
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${error.message}</p></div>`;
    }
}

// æ¸²æŸ“ç”³è¯·å¡ç‰‡
function renderAppCard(app, mode) {
 let statusText = {
    pending: 'â³ å¾…å®¡æ‰¹',
    approved: 'âœ… å·²é€šè¿‡',
    rejected: 'âŒ å·²é©³å›'
}[app.status];

// å¦‚æœå·²æŠ¥è´¦ï¼Œæ˜¾ç¤ºå·²æŠ¥è´¦çŠ¶æ€
if (app.status === 'approved' && app.accounting_status === 'accounted') {
    statusText = 'ğŸ’° å·²æŠ¥è´¦';
}
  
  const statusClass = 'status-' + app.status;
  
  let itemsHtml = '<table><tr><th>ç‰©å“</th><th>æ•°é‡</th><th>å•ä»·</th><th>å°è®¡</th></tr>';
  app.items.forEach(item => {
    itemsHtml += `<tr>
      <td>${item.item_name}</td>
      <td>${item.quantity} ${item.unit}</td>
      <td>Â¥${parseFloat(item.price).toFixed(2)}</td>
      <td>Â¥${parseFloat(item.subtotal).toFixed(2)}</td>
    </tr>`;
  });
  itemsHtml += '</table>';
  // æ˜¾ç¤ºé™„ä»¶
  let attachHtml = '';
  if (app.attachments && app.attachments.length > 0) {
    attachHtml = '<div style="margin-top:10px"><strong>ğŸ“ é™„ä»¶ï¼š</strong><div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:5px">';
    app.attachments.forEach(att => {
      if (att.file_type && att.file_type.startsWith('image/')) {
      attachHtml += `<a href="http://localhost:3000/uploads/${att.file_path}" target="_blank"><img src="http://localhost:3000/uploads/${att.file_path}"" style="width:60px;height:60px;object-fit:cover;border-radius:4px;border:1px solid #ddd"></a>`;
      } else {
        attachHtml += `<a href="http://localhost:3000/uploads/${att.file_path}" target="_blank" style="padding:5px 10px;background:#f0f0f0;border-radius:4px;font-size:12px">ğŸ“„ ${att.file_name}</a>`;
      }
    });
    attachHtml += '</div></div>';
  }
  let actionsHtml = '';
  if (mode === 'approve' && app.status === 'pending') {
    actionsHtml = `
      <div class="review-form">
        <textarea id="review_${app.id}" rows="2" placeholder="å®¡æ‰¹æ„è§ï¼ˆå¯é€‰ï¼‰"></textarea>
        <div class="app-card-actions">
          <button class="btn-small btn-success" onclick="reviewApp(${app.id}, 'approved')">âœ… é€šè¿‡</button>
          <button class="btn-small btn-danger" onclick="reviewApp(${app.id}, 'rejected')">âŒ é©³å›</button>
        </div>
      </div>
    `;
  }
  
  if (mode === 'finance' && app.status === 'approved') {
    if (app.accounting_status === 'accounted') {
      actionsHtml = `<div style="margin-top:10px;padding:10px;background:#d4edda;border-radius:6px;font-size:13px">
        âœ… å·²æŠ¥è´¦ - ${formatDate(app.accounting_time)} ${app.accounting_person ? '| ' + app.accounting_person : ''}
      </div>`;
    } else {
      actionsHtml = `<div class="app-card-actions" style="margin-top:15px">
        <button class="btn-small btn-success" onclick="markAccounted(${app.id})">ğŸ’¼ æ ‡è®°æŠ¥è´¦</button>
      </div>`;
    }
  }
  
  return `
    <div class="app-card ${app.status}">
      <div class="app-card-header">
        <div>
          <span class="app-no">${app.app_no}</span>
          <strong>${app.purchaser_name}</strong> - ${app.purchase_date}
        </div>
        <span class="status-badge ${statusClass}">${statusText}</span>
      </div>
      <div class="app-card-body">
  <p><strong>æ€»é‡‘é¢ï¼š</strong>Â¥${parseFloat(app.total_amount).toFixed(2)}</p>
  ${app.notes ? `<p><strong>å¤‡æ³¨ï¼š</strong>${app.notes}</p>` : ''}
  ${app.review_notes ? `<p><strong>å®¡æ‰¹æ„è§ï¼š</strong>${app.review_notes}</p>` : ''}
  ${app.ai_suggestion ? `<div class="ai-suggestion">${app.ai_suggestion}</div>` : ''}
  <div class="app-items">${itemsHtml}${attachHtml}</div>
</div>
      ${actionsHtml}
    </div>
  `;
}

// ============================================================
// å®¡æ‰¹ç®¡ç†
// ============================================================

async function loadApproveList() {
  const container = document.getElementById('approveList');
  const statsContainer = document.getElementById('approveStats');
  
  
  try {
    // è·å–ç»Ÿè®¡æ•°æ®
    const statsResult = await apiRequest('/applications/stats/summary');
    const stats = statsResult.data;
    
    statsContainer.innerHTML = `
      <div class="stat-card orange"><div class="stat-number">${stats.pending || 0}</div><div class="stat-label">å¾…å®¡æ‰¹</div></div>
      <div class="stat-card green"><div class="stat-number">${stats.approved || 0}</div><div class="stat-label">å·²é€šè¿‡</div></div>
      <div class="stat-card red"><div class="stat-number">${stats.rejected || 0}</div><div class="stat-label">å·²é©³å›</div></div>
      <div class="stat-card blue"><div class="stat-number">${stats.learnedItems || 0}</div><div class="stat-label">AIå·²å­¦ä¹ </div></div>
    `;
    
    // è·å–ç”³è¯·åˆ—è¡¨
    const status = document.getElementById('filterStatus').value;
    const searchItem = document.getElementById('approveSearchItem')?.value.trim() || '';
    
    const params = [];
    if (status) params.push(`status=${status}`);
    if (searchItem) params.push(`itemName=${encodeURIComponent(searchItem)}`);
    
    const result = await apiRequest('/applications' + (params.length > 0 ? '?' + params.join('&') : ''));
    const apps = result.data.list;
    
    if (apps.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>æš‚æ— ç”³è¯·</p></div>';
      return;
    }
    
    container.innerHTML = apps.map(app => renderAppCard(app, 'approve')).join('');
    
  } catch (error) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${error.message}</p></div>`;
  }
}

// å®¡æ‰¹ç”³è¯·
async function reviewApp(id, status) {
  const reviewNotes = document.getElementById('review_' + id)?.value || '';
  
  if (!confirm(status === 'approved' ? 'ç¡®å®šé€šè¿‡æ­¤ç”³è¯·ï¼Ÿ' : 'ç¡®å®šé©³å›æ­¤ç”³è¯·ï¼Ÿ')) {
    return;
  }
  
  try {
    await apiRequest(`/applications/${id}/review`, {
      method: 'PUT',
      body: JSON.stringify({ status, reviewNotes })
    });
    
    showToast(status === 'approved' ? 'å·²æ‰¹å‡†' : 'å·²é©³å›', 'success');
    loadApproveList();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// ============================================================
// è´¢åŠ¡æŠ¥è´¦
// ============================================================

async function loadFinanceList() {
  const container = document.getElementById('financeList');
  const statsContainer = document.getElementById('financeStats');
  
  
  try {
    // è·å–ç»Ÿè®¡
    const statsResult = await apiRequest('/applications/stats/summary');
    const stats = statsResult.data;
    
    statsContainer.innerHTML = `
      <div class="stat-card green"><div class="stat-number">${stats.approved || 0}</div><div class="stat-label">å·²æ‰¹å‡†</div></div>
      <div class="stat-card blue"><div class="stat-number">${stats.waiting || 0}</div><div class="stat-label">å¾…æŠ¥è´¦</div></div>
      <div class="stat-card"><div class="stat-number">${stats.accounted || 0}</div><div class="stat-label">å·²æŠ¥è´¦</div></div>
    `;
    
    // è·å–å·²æ‰¹å‡†çš„ç”³è¯·
    const searchItem = document.getElementById('financeSearchItem')?.value.trim() || '';
    let financeUrl = '/applications?status=approved';
    if (searchItem) {
      financeUrl += `&itemName=${encodeURIComponent(searchItem)}`;
    }
    const result = await apiRequest(financeUrl);
    const apps = result.data.list;
    
    if (apps.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>æš‚æ— å¾…æŠ¥è´¦ç”³è¯·</p></div>';
      return;
    }
    
    container.innerHTML = apps.map(app => renderAppCard(app, 'finance')).join('');
    
  } catch (error) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${error.message}</p></div>`;
  }
}

// æ ‡è®°æŠ¥è´¦
async function markAccounted(id) {
  const notes = prompt('æŠ¥è´¦å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š');
  
  try {
    await apiRequest(`/applications/${id}/account`, {
      method: 'PUT',
      body: JSON.stringify({ accountingNotes: notes })
    });
    
    showToast('å·²æ ‡è®°æŠ¥è´¦', 'success');
    loadFinanceList();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// ============================================================
// äººæ•°ç®¡ç†
// ============================================================

function openCountModal() {
  const today = new Date().toISOString().split('T')[0];
  
  document.getElementById('modalTitle').textContent = 'ğŸ‘¥ ç™»è®°äººæ•°';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>æ—¥æœŸ</label>
      <input type="date" id="countDate" value="${today}">
    </div>
    <div class="form-group">
      <label>åœ¨ä½äººæ•°</label>
      <input type="number" id="countNum" placeholder="ä¾‹å¦‚ï¼š85" min="0">
    </div>
    <div class="form-group">
      <label>å¤‡æ³¨</label>
      <input type="text" id="countNotes" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«ã€æ—ºå­£">
    </div>
    <button class="btn btn-primary" onclick="saveCount()" style="margin-top:15px">ğŸ’¾ ä¿å­˜</button>
  `;
  
  document.getElementById('modal').classList.add('active');
}

async function saveCount() {
  const date = document.getElementById('countDate').value;
  const count = parseInt(document.getElementById('countNum').value);
  const notes = document.getElementById('countNotes').value;
  
  if (!date || isNaN(count)) {
    showToast('è¯·å¡«å†™æ—¥æœŸå’Œäººæ•°', 'error');
    return;
  }
  
  try {
    await apiRequest('/daily-counts', {
      method: 'POST',
      body: JSON.stringify({ date, count, notes })
    });
    
    showToast('ä¿å­˜æˆåŠŸ', 'success');
    closeModal();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

async function viewCountHistory() {
  document.getElementById('modalTitle').textContent = 'ğŸ“Š äººæ•°è®°å½•';
  document.getElementById('modalBody').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
  document.getElementById('modal').classList.add('active');
  
  try {
    const result = await apiRequest('/daily-counts');
    const { list, stats } = result.data;
    
    if (list.length === 0) {
      document.getElementById('modalBody').innerHTML = '<div class="empty-state"><p>æš‚æ— è®°å½•</p></div>';
      return;
    }
    
    let html = `
      <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px">
        <strong>ç»Ÿè®¡ï¼š</strong>å…±${stats.totalDays}å¤© | å¹³å‡${stats.avgCount}äºº | æœ€é«˜${stats.maxCount}äºº | æœ€ä½${stats.minCount}äºº
      </div>
      <div style="max-height:400px;overflow-y:auto">
    `;
    
    list.forEach(c => {
      html += `
        <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div><strong>${c.record_date}</strong> ${c.notes ? '- ' + c.notes : ''}</div>
          <div style="color:#667eea;font-weight:600">${c.guest_count}äºº</div>
        </div>
      `;
    });
    
    html += '</div>';
    document.getElementById('modalBody').innerHTML = html;
    
  } catch (error) {
    document.getElementById('modalBody').innerHTML = `<div class="empty-state"><p>${error.message}</p></div>`;
  }
}

// ============================================================
// ç”¨æˆ·ç®¡ç†
// ============================================================

async function loadUsers() {
  const container = document.getElementById('usersList');
  
  
  try {
    const result = await apiRequest('/users');
    const users = result.data;
    
    const roleNames = {
      purchaser: 'é‡‡è´­å‘˜',
      boss: 'è€æ¿',
      finance: 'è´¢åŠ¡',
      admin: 'ç®¡ç†å‘˜'
    };
    
    let html = '<table style="width:100%;border-collapse:collapse">';
    html += '<tr style="background:#f8f9fa"><th style="padding:12px;text-align:left">ç”¨æˆ·å</th><th style="padding:12px;text-align:left">å§“å</th><th style="padding:12px;text-align:left">è§’è‰²</th><th style="padding:12px;text-align:left">çŠ¶æ€</th><th style="padding:12px;text-align:left">æ“ä½œ</th></tr>';
    
    users.forEach(u => {
      html += `<tr style="border-bottom:1px solid #e0e0e0">
        <td style="padding:12px">${u.username}</td>
        <td style="padding:12px">${u.name}</td>
        <td style="padding:12px">${roleNames[u.role] || u.role}</td>
        <td style="padding:12px">${u.status === 1 ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</td>
        <td style="padding:12px">
          <button class="btn-small btn-info" onclick="openEditUserModal(${u.id}, '${u.username}', '${u.name}', '${u.role}', ${u.status})">ç¼–è¾‘</button>
          <button class="btn-small btn-danger" onclick="deleteUser(${u.id}, '${u.username}')">åˆ é™¤</button>
        </td>
      </tr>`;
    });
    
    html += '</table>';
    container.innerHTML = html;
    
  } catch (error) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${error.message}</p></div>`;
  }
}

function openAddUserModal() {
  document.getElementById('modalTitle').textContent = 'â• æ·»åŠ ç”¨æˆ·';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>ç”¨æˆ·åï¼ˆç™»å½•ç”¨ï¼‰</label>
      <input type="text" id="newUsername" placeholder="ä¾‹å¦‚ï¼šzhangsan">
    </div>
    <div class="form-group">
      <label>å¯†ç </label>
      <input type="password" id="newPassword" placeholder="è‡³å°‘6ä½">
    </div>
    <div class="form-group">
      <label>å§“å</label>
      <input type="text" id="newName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
    </div>
    <div class="form-group">
      <label>è§’è‰²</label>
      <select id="newRole">
        <option value="purchaser">é‡‡è´­å‘˜</option>
        <option value="finance">è´¢åŠ¡</option>
        <option value="boss">è€æ¿</option>
        <option value="admin">ç®¡ç†å‘˜</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="createUser()" style="margin-top:15px">âœ… åˆ›å»ºç”¨æˆ·</button>
  `;
  
  document.getElementById('modal').classList.add('active');
}

async function createUser() {
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value;
  const name = document.getElementById('newName').value.trim();
  const role = document.getElementById('newRole').value;
  
  if (!username || !password || !name) {
    showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
    return;
  }
  
  if (password.length < 6) {
    showToast('å¯†ç è‡³å°‘6ä½', 'error');
    return;
  }
  
  try {
    await apiRequest('/users', {
      method: 'POST',
      body: JSON.stringify({ username, password, name, role })
    });
    
    showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
    closeModal();
    loadUsers();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}
// æ‰“å¼€ç¼–è¾‘ç”¨æˆ·å¼¹çª—
function openEditUserModal(id, username, name, role, status) {
  document.getElementById('modalTitle').textContent = 'âœï¸ ç¼–è¾‘ç”¨æˆ·';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>ç”¨æˆ·å</label>
      <input type="text" value="${username}" disabled style="background:#eee">
    </div>
    <div class="form-group">
      <label>æ–°å¯†ç ï¼ˆä¸ä¿®æ”¹è¯·ç•™ç©ºï¼‰</label>
      <input type="password" id="editPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
    </div>
    <div class="form-group">
      <label>å§“å</label>
      <input type="text" id="editName" value="${name}">
    </div>
    <div class="form-group">
      <label>è§’è‰²</label>
      <select id="editRole">
        <option value="purchaser" ${role === 'purchaser' ? 'selected' : ''}>é‡‡è´­å‘˜</option>
        <option value="finance" ${role === 'finance' ? 'selected' : ''}>è´¢åŠ¡</option>
        <option value="boss" ${role === 'boss' ? 'selected' : ''}>è€æ¿</option>
        <option value="admin" ${role === 'admin' ? 'selected' : ''}>ç®¡ç†å‘˜</option>
      </select>
    </div>
    <div class="form-group">
      <label>çŠ¶æ€</label>
      <select id="editStatus">
        <option value="1" ${status === 1 ? 'selected' : ''}>å¯ç”¨</option>
        <option value="0" ${status === 0 ? 'selected' : ''}>ç¦ç”¨</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="updateUser(${id})" style="margin-top:15px">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
  `;
  
  document.getElementById('modal').classList.add('active');
}

// æ›´æ–°ç”¨æˆ·
async function updateUser(id) {
  const password = document.getElementById('editPassword').value;
  const name = document.getElementById('editName').value.trim();
  const role = document.getElementById('editRole').value;
  const status = parseInt(document.getElementById('editStatus').value);
  
  if (!name) {
    showToast('è¯·å¡«å†™å§“å', 'error');
    return;
  }
  
  try {
    const data = { name, role, status };
    if (password) {
      if (password.length < 6) {
        showToast('å¯†ç è‡³å°‘6ä½', 'error');
        return;
      }
      data.password = password;
    }
    
    await apiRequest(`/users/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data)
    });
    
    showToast('ä¿®æ”¹æˆåŠŸ', 'success');
    closeModal();
    loadUsers();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// åˆ é™¤ç”¨æˆ·
async function deleteUser(id, username) {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
    return;
  }
  
  try {
    await apiRequest(`/users/${id}`, {
      method: 'DELETE'
    });
    
    showToast('ç”¨æˆ·å·²åˆ é™¤', 'success');
    loadUsers();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}
// ============================================================
// æ¨¡æ€æ¡†
// ============================================================

function closeModal() {
  document.getElementById('modal').classList.remove('active');
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ============================================================
// åˆå§‹åŒ–
// ============================================================

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
checkAuth();
// ============================================================
// AIæ•°æ®ç®¡ç†
// ============================================================

// å½“å‰AIæ•°æ®ç¼“å­˜
let currentAIData = [];
let currentAIDataType = 'prices';

// è¿‡æ»¤AIæ•°æ®
function filterAIData() {
  const keyword = document.getElementById('aiSearchKeyword').value.trim().toLowerCase();
  
  if (currentAIDataType === 'prices') {
    renderAIPrices(currentAIData, keyword);
  } else {
    renderAIConsumption(currentAIData, keyword);
  }
}

// åŠ è½½ä»·æ ¼æ•°æ®
async function loadAIPrices() {
  const container = document.getElementById('aiDataList');
  container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
  document.getElementById('aiSearchKeyword').value = '';
  
  try {
    const result = await apiRequest('/ai/prices');
    currentAIData = result.data;
    currentAIDataType = 'prices';
    
    if (currentAIData.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>æš‚æ— ä»·æ ¼å­¦ä¹ æ•°æ®</p></div>';
      return;
    }
    
    renderAIPrices(currentAIData, '');
    
  } catch (error) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${error.message}</p></div>`;
  }
}

// æ¸²æŸ“ä»·æ ¼æ•°æ®
function renderAIPrices(prices, keyword) {
  const container = document.getElementById('aiDataList');
  
  let filtered = prices;
  if (keyword) {
    filtered = prices.filter(p => p.item_name.toLowerCase().includes(keyword));
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…"${keyword}"çš„ç‰©å“</p></div>`;
    return;
  }
  
  let html = `
    <h3 style="margin-bottom:15px">ğŸ’° ä»·æ ¼å­¦ä¹ æ•°æ®ï¼ˆæ˜¾ç¤º${filtered.length}é¡¹${keyword ? 'ï¼Œå…±' + prices.length + 'é¡¹' : ''}ï¼‰</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden">
      <tr style="background:#667eea;color:#fff">
        <th style="padding:12px;text-align:left">ç‰©å“åç§°</th>
        <th style="padding:12px;text-align:right">å¹³å‡ä»·</th>
        <th style="padding:12px;text-align:right">æœ€ä½ä»·</th>
        <th style="padding:12px;text-align:right">æœ€é«˜ä»·</th>
        <th style="padding:12px;text-align:center">é¢„è­¦é˜ˆå€¼</th>
        <th style="padding:12px;text-align:center">å­¦ä¹ æ¬¡æ•°</th>
        <th style="padding:12px;text-align:center">æ“ä½œ</th>
      </tr>
  `;
  
  filtered.forEach(p => {
    const avgPrice = p.count > 0 ? (p.total_price / p.count).toFixed(2) : '0.00';
    const threshold = p.alert_threshold || 20;
    
    let displayName = p.item_name;
    if (keyword) {
      const regex = new RegExp(`(${keyword})`, 'gi');
      displayName = p.item_name.replace(regex, '<span style="background:#ffeb3b;padding:0 2px">$1</span>');
    }
    
    html += `
      <tr style="border-bottom:1px solid #e0e0e0">
        <td style="padding:12px">${displayName}</td>
        <td style="padding:12px;text-align:right;font-weight:600;color:#667eea">Â¥${avgPrice}</td>
        <td style="padding:12px;text-align:right;color:#28a745">Â¥${parseFloat(p.min_price).toFixed(2)}</td>
        <td style="padding:12px;text-align:right;color:#dc3545">Â¥${parseFloat(p.max_price).toFixed(2)}</td>
        <td style="padding:12px;text-align:center"><span style="color:#ff9800;font-weight:600">Â±${threshold}%</span></td>
        <td style="padding:12px;text-align:center">${p.count}æ¬¡</td>
        <td style="padding:12px;text-align:center">
          <button class="btn-small btn-info" onclick="editPrice('${p.item_name}', ${avgPrice}, ${threshold})">ç¼–è¾‘</button>
          <button class="btn-small btn-danger" onclick="deletePrice('${p.item_name}')">åˆ é™¤</button>
        </td>
      </tr>
    `;
  });
  
  html += '</table>';
  container.innerHTML = html;
}

// åŠ è½½æ¶ˆè€—æ•°æ®
async function loadAIConsumption() {
  const container = document.getElementById('aiDataList');
  container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
  document.getElementById('aiSearchKeyword').value = '';
  
  try {
    const result = await apiRequest('/ai/consumption');
    currentAIData = result.data;
    currentAIDataType = 'consumption';
    
    if (currentAIData.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>æš‚æ— æ¶ˆè€—å­¦ä¹ æ•°æ®</p></div>';
      return;
    }
    
    renderAIConsumption(currentAIData, '');
    
  } catch (error) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${error.message}</p></div>`;
  }
}

// æ¸²æŸ“æ¶ˆè€—æ•°æ®
function renderAIConsumption(rates, keyword) {
  const container = document.getElementById('aiDataList');
  
  let filtered = rates;
  if (keyword) {
    filtered = rates.filter(r => r.item_name.toLowerCase().includes(keyword));
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…"${keyword}"çš„ç‰©å“</p></div>`;
    return;
  }
  
  let html = `
    <h3 style="margin-bottom:15px">ğŸ“Š æ¶ˆè€—å­¦ä¹ æ•°æ®ï¼ˆæ˜¾ç¤º${filtered.length}é¡¹${keyword ? 'ï¼Œå…±' + rates.length + 'é¡¹' : ''}ï¼‰</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden">
      <tr style="background:#ff9800;color:#fff">
        <th style="padding:12px;text-align:left">ç‰©å“åç§°</th>
        <th style="padding:12px;text-align:right">å¹³å‡æ¶ˆè€—ç‡</th>
        <th style="padding:12px;text-align:center">å­¦ä¹ æ¬¡æ•°</th>
        <th style="padding:12px;text-align:center">æ“ä½œ</th>
      </tr>
  `;
  
  filtered.forEach(r => {
    let displayName = r.item_name;
    if (keyword) {
      const regex = new RegExp(`(${keyword})`, 'gi');
      displayName = r.item_name.replace(regex, '<span style="background:#ffeb3b;padding:0 2px">$1</span>');
    }
    
    html += `
      <tr style="border-bottom:1px solid #e0e0e0">
        <td style="padding:12px">${displayName}</td>
        <td style="padding:12px;text-align:right;font-weight:600;color:#ff9800">${parseFloat(r.avg_rate).toFixed(4)}/äºº</td>
        <td style="padding:12px;text-align:center">${r.count}æ¬¡</td>
        <td style="padding:12px;text-align:center">
          <button class="btn-small btn-info" onclick="editConsumption('${r.item_name}', ${r.avg_rate})">ç¼–è¾‘</button>
          <button class="btn-small btn-danger" onclick="deleteConsumption('${r.item_name}')">åˆ é™¤</button>
        </td>
      </tr>
    `;
  });
  
  html += '</table>';
  container.innerHTML = html;
}

// ç¼–è¾‘ä»·æ ¼
function editPrice(itemName, currentPrice, currentThreshold) {
  currentThreshold = currentThreshold || 20;
  
  document.getElementById('modalTitle').textContent = `ğŸ“ ç¼–è¾‘ã€${itemName}ã€‘`;
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>å¹³å‡ä»·æ ¼ (Â¥)</label>
      <input type="number" id="editPriceValue" value="${currentPrice}" step="0.01">
    </div>
    <div class="form-group">
      <label>é¢„è­¦é˜ˆå€¼ (%)</label>
      <input type="number" id="editThreshold" value="${currentThreshold}" min="1" max="100">
      <p style="font-size:12px;color:#666;margin-top:5px">è¶…å‡ºå¹³å‡ä»·æ­¤ç™¾åˆ†æ¯”å°†è§¦å‘é¢„è­¦æç¤º</p>
    </div>
    <button class="btn btn-primary" onclick="saveEditPrice('${itemName}')" style="margin-top:15px">ğŸ’¾ ä¿å­˜</button>
  `;
  
  document.getElementById('modal').classList.add('active');
}

// ä¿å­˜ç¼–è¾‘çš„ä»·æ ¼
async function saveEditPrice(itemName) {
  const avgPrice = parseFloat(document.getElementById('editPriceValue').value);
  const alertThreshold = parseInt(document.getElementById('editThreshold').value);
  
  if (isNaN(avgPrice) || avgPrice <= 0) {
    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼', 'error');
    return;
  }
  
  if (isNaN(alertThreshold) || alertThreshold < 1 || alertThreshold > 100) {
    showToast('é˜ˆå€¼è¯·è¾“å…¥1-100ä¹‹é—´çš„æ•°å­—', 'error');
    return;
  }
  
  try {
    await apiRequest(`/ai/prices/${encodeURIComponent(itemName)}`, {
      method: 'PUT',
      body: JSON.stringify({ avgPrice, alertThreshold })
    });
    
    showToast('å·²æ›´æ–°', 'success');
    closeModal();
    loadAIPrices();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// åˆ é™¤ä»·æ ¼
async function deletePrice(itemName) {
  if (!confirm(`ç¡®å®šåˆ é™¤ã€${itemName}ã€‘çš„ä»·æ ¼æ•°æ®ï¼Ÿ`)) return;
  
  try {
    await apiRequest(`/ai/prices/${encodeURIComponent(itemName)}`, {
      method: 'DELETE'
    });
    
    showToast('å·²åˆ é™¤', 'success');
    loadAIPrices();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// ç¼–è¾‘æ¶ˆè€—ç‡
async function editConsumption(itemName, currentRate) {
  const newRate = prompt(`ä¿®æ”¹ã€${itemName}ã€‘çš„å¹³å‡æ¶ˆè€—ç‡ï¼ˆæ¯äººï¼‰ï¼š`, currentRate);
  
  if (newRate === null) return;
  
  const rate = parseFloat(newRate);
  if (isNaN(rate) || rate <= 0) {
    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè€—ç‡', 'error');
    return;
  }
  
  try {
    await apiRequest(`/ai/consumption/${encodeURIComponent(itemName)}`, {
      method: 'PUT',
      body: JSON.stringify({ avgRate: rate })
    });
    
    showToast('æ¶ˆè€—ç‡å·²æ›´æ–°', 'success');
    loadAIConsumption();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// åˆ é™¤æ¶ˆè€—ç‡
async function deleteConsumption(itemName) {
  if (!confirm(`ç¡®å®šåˆ é™¤ã€${itemName}ã€‘çš„æ¶ˆè€—æ•°æ®ï¼Ÿ`)) return;
  
  try {
    await apiRequest(`/ai/consumption/${encodeURIComponent(itemName)}`, {
      method: 'DELETE'
    });
    
    showToast('å·²åˆ é™¤', 'success');
    loadAIConsumption();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// æ·»åŠ ä»·æ ¼æ•°æ®
function openAddPriceModal() {
  document.getElementById('modalTitle').textContent = 'â• æ·»åŠ ä»·æ ¼æ•°æ®';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>ç‰©å“åç§°</label>
      <input type="text" id="newPriceItem" placeholder="ä¾‹å¦‚ï¼šå¤§ç±³">
    </div>
    <div class="form-group">
      <label>å‚è€ƒä»·æ ¼</label>
      <input type="number" id="newPriceValue" placeholder="ä¾‹å¦‚ï¼š5.5" step="0.01">
    </div>
    <button class="btn btn-primary" onclick="saveNewPrice()" style="margin-top:15px">ğŸ’¾ ä¿å­˜</button>
  `;
  
  document.getElementById('modal').classList.add('active');
}

async function saveNewPrice() {
  const itemName = document.getElementById('newPriceItem').value.trim();
  const price = parseFloat(document.getElementById('newPriceValue').value);
  
  if (!itemName || isNaN(price) || price <= 0) {
    showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
    return;
  }
  
  try {
    await apiRequest('/ai/prices', {
      method: 'POST',
      body: JSON.stringify({ itemName, price })
    });
    
    showToast('æ·»åŠ æˆåŠŸ', 'success');
    closeModal();
    loadAIPrices();
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// å¯¼å‡ºAIæ•°æ®
async function exportAIData() {
  try {
    const result = await apiRequest('/ai/export');
    const data = result.data;
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-data-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('å¯¼å‡ºæˆåŠŸ', 'success');
    
  } catch (error) {
    showToast(error.message, 'error');
  }
}
// å¯¼å‡ºExcel
async function exportExcel(type) {
  let url = '/api/applications/export/excel';
  const params = [];
  
  if (type === 'approve') {
    const status = document.getElementById('filterStatus')?.value;
    const searchItem = document.getElementById('approveSearchItem')?.value.trim();
    if (status) params.push(`status=${status}`);
    if (searchItem) params.push(`itemName=${encodeURIComponent(searchItem)}`);
  } else if (type === 'finance') {
    const searchItem = document.getElementById('financeSearchItem')?.value.trim();
    if (searchItem) params.push(`itemName=${encodeURIComponent(searchItem)}`);
  }
  
  if (params.length > 0) {
    url += '?' + params.join('&');
  }
  
  try {
    showToast('æ­£åœ¨å¯¼å‡º...', 'info');
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });
    
    if (!response.ok) {
      throw new Error('å¯¼å‡ºå¤±è´¥');
    }
    
    // è·å–æ–‡ä»¶å¹¶ä¸‹è½½
    const blob = await response.blob();
    const downloadUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = `é‡‡è´­æ•°æ®_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(downloadUrl);
    
    showToast('å¯¼å‡ºæˆåŠŸ', 'success');
  } catch (error) {
    showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
  }
}
// ============================================================
// å¸¸ç”¨ç‰©å“ç®¡ç†
// ============================================================

// å¸¸ç”¨ç‰©å“ç›¸å…³å˜é‡
let categoriesData = [];
let currentCategoryId = null;

// åŠ è½½å¸¸ç”¨ç‰©å“åˆ†ç±»å’Œç‰©å“
async function loadCommonItems() {
  try {
    const result = await apiRequest('/items/categories');
    categoriesData = result.data;
    renderCategoryTabs();
  } catch (error) {
    console.error('åŠ è½½å¸¸ç”¨ç‰©å“å¤±è´¥:', error);
  }
}

// æ¸²æŸ“åˆ†ç±»æ ‡ç­¾
function renderCategoryTabs() {
  const container = document.getElementById('categoryTabs');
  if (!categoriesData || categoriesData.length === 0) {
    container.innerHTML = '<span style="color:#999">æš‚æ— åˆ†ç±»ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </span>';
    document.getElementById('categoryItems').innerHTML = '';
    return;
  }
  
  let html = '';
  categoriesData.forEach((cat, index) => {
    const isActive = index === 0 ? 'active' : '';
    html += `<div class="category-tab ${isActive}" onclick="selectCategory(${cat.id})">${cat.name}</div>`;
  });
  container.innerHTML = html;
  
  // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç±»
  if (categoriesData.length > 0) {
    selectCategory(categoriesData[0].id);
  }
}

// é€‰æ‹©åˆ†ç±»
function selectCategory(categoryId) {
  currentCategoryId = categoryId;
  
  // æ›´æ–°æ ‡ç­¾æ ·å¼
  document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
  if (event && event.target) {
    event.target.classList.add('active');
  }
  
  // æ¸²æŸ“è¯¥åˆ†ç±»ä¸‹çš„ç‰©å“
  const category = categoriesData.find(c => c.id === categoryId);
  const container = document.getElementById('categoryItems');
  
  if (!category || !category.items || category.items.length === 0) {
    container.innerHTML = '<div style="color:#999;text-align:center;padding:20px">è¯¥åˆ†ç±»ä¸‹æš‚æ— ç‰©å“</div>';
    return;
  }
  
  let html = '';
  category.items.forEach(item => {
    html += `
      <div class="common-item" onclick="addCommonItemToList(${item.id}, '${item.item_name}', '${item.unit}', ${item.last_price})">
        <div class="item-name">${item.item_name}</div>
        <div class="item-info">${item.unit} | Â¥${item.last_price}</div>
      </div>
    `;
  });
  container.innerHTML = html;
}

// æ·»åŠ å¸¸ç”¨ç‰©å“åˆ°é‡‡è´­æ¸…å•
function addCommonItemToList(id, name, unit, price) {
  const container = document.getElementById('submitItems');
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰©å“
  const existingNames = Array.from(container.querySelectorAll('.item-name')).map(input => input.value.trim());
  if (existingNames.includes(name)) {
    showToast('è¯¥ç‰©å“å·²åœ¨æ¸…å•ä¸­', 'error');
    return;
  }
  
  // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™å¡«å……ï¼Œå¦åˆ™æ·»åŠ æ–°è¡Œ
  const firstRow = container.querySelector('.item-row');
  const firstName = firstRow.querySelector('.item-name').value.trim();
  
  if (!firstName) {
    // å¡«å……ç¬¬ä¸€è¡Œ
    firstRow.querySelector('.item-name').value = name;
    firstRow.querySelector('.item-unit').value = unit;
    firstRow.querySelector('.item-price').value = price;
    firstRow.querySelector('.item-qty').focus();
  } else {
    // æ·»åŠ æ–°è¡Œ
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
      <input type="text" placeholder="ç‰©å“åç§°" class="item-name" value="${name}" required>
      <input type="number" placeholder="æ•°é‡" class="item-qty" step="0.01" required>
      <input type="text" placeholder="å•ä½" class="item-unit" value="${unit}" required>
      <input type="number" placeholder="å•ä»·" class="item-price" step="0.01" value="${price}" required>
      <button type="button" class="btn-remove" onclick="removeItem(this)">åˆ é™¤</button>
    `;
    container.appendChild(row);
    row.querySelector('.item-qty').focus();
  }
  
  updateTotal();
  showToast(`å·²æ·»åŠ : ${name}`, 'success');
}

// æ‰“å¼€ç®¡ç†å¸¸ç”¨ç‰©å“å¼¹çª—
function openManageItemsModal() {
  document.getElementById('modalTitle').textContent = 'âš™ï¸ ç®¡ç†å¸¸ç”¨ç‰©å“';
  
  let categoriesHtml = '';
  categoriesData.forEach(cat => {
    let itemsHtml = '';
    if (cat.items && cat.items.length > 0) {
      cat.items.forEach(item => {
        itemsHtml += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#f8f9fa;border-radius:6px;margin-bottom:5px">
            <span>${item.item_name} (${item.unit}, Â¥${item.last_price})</span>
            <button class="btn-small btn-danger" onclick="deleteCommonItem(${item.id})">åˆ é™¤</button>
          </div>
        `;
      });
    } else {
      itemsHtml = '<div style="color:#999;padding:10px">æš‚æ— ç‰©å“</div>';
    }
    
    categoriesHtml += `
      <div style="margin-bottom:20px;border:1px solid #e0e0e0;border-radius:8px;padding:15px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>${cat.name}</strong>
          <button class="btn-small btn-danger" onclick="deleteCategory(${cat.id})">åˆ é™¤åˆ†ç±»</button>
        </div>
        ${itemsHtml}
        <button class="btn-small btn-success" onclick="openAddItemModal(${cat.id}, '${cat.name}')" style="margin-top:10px">â• æ·»åŠ ç‰©å“</button>
      </div>
    `;
  });
  
  document.getElementById('modalBody').innerHTML = `
    <div style="margin-bottom:20px">
      <button class="btn-small btn-primary" onclick="openAddCategoryModal()">â• æ·»åŠ æ–°åˆ†ç±»</button>
    </div>
    ${categoriesHtml || '<div style="color:#999">æš‚æ— åˆ†ç±»</div>'}
  `;
  
  document.getElementById('modal').classList.add('active');
}

// æ‰“å¼€æ·»åŠ åˆ†ç±»å¼¹çª—
function openAddCategoryModal() {
  document.getElementById('modalTitle').textContent = 'â• æ·»åŠ åˆ†ç±»';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>åˆ†ç±»åç§°</label>
      <input type="text" id="newCategoryName" placeholder="ä¾‹å¦‚ï¼šè”¬èœã€è‚‰ç±»">
    </div>
    <button class="btn btn-primary" onclick="addCategory()" style="margin-top:15px">âœ… æ·»åŠ </button>
    <button class="btn-small" onclick="openManageItemsModal()" style="margin-top:15px;margin-left:10px">è¿”å›</button>
  `;
}

// æ·»åŠ åˆ†ç±»
async function addCategory() {
  const name = document.getElementById('newCategoryName').value.trim();
  if (!name) {
    showToast('è¯·è¾“å…¥åˆ†ç±»åç§°', 'error');
    return;
  }
  
  try {
    await apiRequest('/items/categories', {
      method: 'POST',
      body: JSON.stringify({ name })
    });
    
    showToast('åˆ†ç±»æ·»åŠ æˆåŠŸ', 'success');
    await loadCommonItems();
    openManageItemsModal();
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// åˆ é™¤åˆ†ç±»
async function deleteCategory(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¯¥åˆ†ç±»å—ï¼Ÿåˆ†ç±»ä¸‹çš„æ‰€æœ‰ç‰©å“ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;
  
  try {
    await apiRequest(`/items/categories/${id}`, { method: 'DELETE' });
    showToast('åˆ†ç±»å·²åˆ é™¤', 'success');
    await loadCommonItems();
    openManageItemsModal();
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// æ‰“å¼€æ·»åŠ ç‰©å“å¼¹çª—
function openAddItemModal(categoryId, categoryName) {
  document.getElementById('modalTitle').textContent = `â• æ·»åŠ ç‰©å“åˆ°ã€${categoryName}ã€‘`;
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label>ç‰©å“åç§°</label>
      <input type="text" id="newItemName" placeholder="ä¾‹å¦‚ï¼šå¤§ç™½èœ">
    </div>
    <div class="form-group">
      <label>å•ä½</label>
      <input type="text" id="newItemUnit" placeholder="ä¾‹å¦‚ï¼šæ–¤ã€ä¸ªã€ç®±">
    </div>
    <div class="form-group">
      <label>å‚è€ƒä»·æ ¼</label>
      <input type="number" id="newItemPrice" placeholder="ä¾‹å¦‚ï¼š3.5" step="0.01">
    </div>
    <button class="btn btn-primary" onclick="addCommonItem(${categoryId})" style="margin-top:15px">âœ… æ·»åŠ </button>
    <button class="btn-small" onclick="openManageItemsModal()" style="margin-top:15px;margin-left:10px">è¿”å›</button>
  `;
}

// æ·»åŠ å¸¸ç”¨ç‰©å“
async function addCommonItem(categoryId) {
  const itemName = document.getElementById('newItemName').value.trim();
  const unit = document.getElementById('newItemUnit').value.trim();
  const lastPrice = parseFloat(document.getElementById('newItemPrice').value) || 0;
  
  if (!itemName || !unit) {
    showToast('è¯·å¡«å†™ç‰©å“åç§°å’Œå•ä½', 'error');
    return;
  }
  
  try {
    await apiRequest('/items', {
      method: 'POST',
      body: JSON.stringify({ categoryId, itemName, unit, lastPrice })
    });
    
    showToast('ç‰©å“æ·»åŠ æˆåŠŸ', 'success');
    await loadCommonItems();
    openManageItemsModal();
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// åˆ é™¤å¸¸ç”¨ç‰©å“
async function deleteCommonItem(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç‰©å“å—ï¼Ÿ')) return;
  
  try {
    await apiRequest(`/items/${id}`, { method: 'DELETE' });
    showToast('ç‰©å“å·²åˆ é™¤', 'success');
    await loadCommonItems();
    openManageItemsModal();
  } catch (error) {
    showToast(error.message, 'error');
  }
}

</script>

</body>
</html>
